[env]
_.file = ".env"

[tools]
terraform = "latest"

[tasks.encrypt]
run = "dotenvx encrypt -k GCP_SA_KEY"

[tasks.decrypt]
run = "dotenvx decrypt"

[tasks.set-project]
description = "Set gcloud project to ensure correct context"
run = """
gcloud config set project $TF_VAR_project_id
gcloud auth application-default set-quota-project $TF_VAR_project_id
"""

[tasks."check"]
description = "Run terraform fmt and validate"
run = """
terraform fmt
terraform validate
"""

[tasks."terraform:clean"]
description = "Clean Terraform init artifacts"
run = "rm -rf terraform/.terraform terraform/.terraform.lock.hcl"

[tasks.migrate-data]
description = "Migrate data from backup to new bucket"
run = "gsutil cp -r ./backup/* gs://actual-bucket-new/"

[tasks.backup-data]
description = "Backup data from old bucket locally"
run = "gsutil cp -r gs://actual-bucket-new/* ./backup/"

[tasks.logs]
description = "Read logs from the Actual server service"
depends = ["set-project"]
run = "gcloud run services logs read actual-server --region $TF_VAR_region --project $TF_VAR_project_id"

[tasks.service-url]
description = "Get the service URL from Terraform output"
run = "terraform output -raw service_url"

[tasks.queue-health]
description = "Check Solid Queue job health (jobs count, workers alive, oldest job age)"
run = """
kamal console << 'EOF'
jobs = SolidQueue::Job.count
workers = SolidQueue::Process.where(kind: 'Worker').count
oldest = SolidQueue::Job.order(:created_at).first
age = oldest ? ((Time.now.utc - oldest.created_at) / 86400).to_i : 0
puts "Jobs: #{jobs} | Workers: #{workers} | Oldest: #{age}d"
pending = SolidQueue::Job.where(finished_at: nil)
completed = SolidQueue::Job.where.not(finished_at: nil)
puts "Pending: #{pending.count} (e.g., #{pending.limit(3).pluck(:class_name).join(', ')})"
puts "Completed: #{completed.count} (e.g., #{completed.limit(3).pluck(:class_name).join(', ')})"
exit
EOF
"""

[tasks.queue-details]
description = "Check Solid Queue job details (list first 5 jobs)"
run = """
kamal console << 'EOF'
puts "First 5 jobs:"
SolidQueue::Job.order(:created_at).limit(5).each do |job|
  age_days = ((Time.now.utc - job.created_at) / 86400).to_i
  status = job.finished_at ? 'completed' : 'pending'
  puts "#{job.id}: #{job.class_name} (#{job.queue_name}) - #{status} - #{age_days}d old"
end
exit
EOF
"""
