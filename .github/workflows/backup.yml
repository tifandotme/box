name: Backup to GCS

on:
  schedule:
    - cron: "0 19 * * *" # Daily at 2AM Jakarta (19:00 UTC)
  workflow_dispatch:
    inputs:
      service:
        description: "Service to backup"
        required: true
        default: "fizzy"
        type: choice
        options:
          - fizzy
          - excalidash

jobs:
  backup:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    strategy:
      matrix:
        service: ${{ fromJson(github.event_name == 'schedule' && '["fizzy", "excalidash"]' || format('["{0}"]', inputs.service)) }}
    env:
      DOTENV_PRIVATE_KEY: ${{ secrets.DOTENV_PRIVATE_KEY }}

    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - uses: ./.github/actions/infra-setup
        with:
          oauth-client-id: ${{ secrets.TS_OAUTH_CLIENT_ID }}
          oauth-secret: ${{ secrets.TS_OAUTH_SECRET }}

      - uses: ./.github/actions/backup-setup
        id: backup-setup
        with:
          service: ${{ matrix.service }}

      - run: kamal app stop -c ${{ matrix.service }}/config/deploy.yml

      - name: Perform Backup
        run: |
          SERVICE="${{ matrix.service }}"
          VOLUME_NAME="${SERVICE}-storage"
          BUCKET_VAR="TF_VAR_${SERVICE}_bucket_name"

          GCS_BUCKET="gs://$(dotenvx get "$BUCKET_VAR" --env-file terraform/.env)"
          DATE=$(date +%Y%m%d-%H%M%S)
          BACKUP_DIR="${VOLUME_NAME}-backup"

          echo "=== Starting Backup: $DATE ==="
          echo "Service: $SERVICE"
          echo "Volume: $VOLUME_NAME"
          echo "Bucket: $GCS_BUCKET"

          echo "Downloading data from server..."
          rsync -avz -e "ssh" eddies@box.javanese-pound.ts.net:/home/eddies/$VOLUME_NAME/ ./$BACKUP_DIR

          echo "Uploading to GCS..."
          gsutil -m rsync -r -d \
            -x ".*\.sqlite3-shm$|.*\.sqlite3-wal$" \
            ./$BACKUP_DIR "$GCS_BUCKET/$DATE"

          echo "âœ“ Backup completed: $GCS_BUCKET/$DATE"

      - name: Start Application
        if: always()
        run: |
          SERVICE="${{ matrix.service }}"
          VERSION="${{ steps.backup-setup.outputs.version }}"

          if [ -n "$VERSION" ]; then
            echo "Restarting specific version: $VERSION"
            kamal app start --version="$VERSION" -c $SERVICE/config/deploy.yml
          else
            echo "Restarting default version..."
            kamal app start -c $SERVICE/config/deploy.yml
          fi
