name: Restore Fizzy

on:
  workflow_dispatch:
    inputs:
      folder_name:
        description: "The folder name in the GCS bucket to restore from (e.g., 20231001-190000)"
        required: true
        type: string

jobs:
  restore:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    env:
      DOTENV_PRIVATE_KEY: ${{ secrets.DOTENV_PRIVATE_KEY }}

    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - uses: ./.github/actions/setup-infra
        with:
          oauth-client-id: ${{ secrets.TS_OAUTH_CLIENT_ID }}
          oauth-secret: ${{ secrets.TS_OAUTH_SECRET }}

      - uses: ./.github/actions/setup-kamal

      - uses: ./.github/actions/setup-gcloud

      - name: Capture Current Version
        id: version
        run: |
          OUTPUT=$(kamal app version -c fizzy/config/deploy.yml)

          # Extract the SHA (assuming the last line containing a 7-char hash is the version)
          SHA=$(echo "$OUTPUT" | grep -oE '[0-9a-f]{7}' | tail -n 1)

          if [ -z "$SHA" ]; then
            echo "::warning::Could not detect running version. Will attempt default start."
          else
            echo "Detected version: $SHA"
            echo "sha=$SHA" >> "$GITHUB_OUTPUT"
          fi

      - run: kamal app stop -c fizzy/config/deploy.yml

      - name: Perform Restore
        run: |
          SERVICE="fizzy"
          VOLUME_NAME="${SERVICE}-storage"
          BUCKET_VAR="TF_VAR_${SERVICE}_bucket_name"

          GCS_BUCKET="gs://$(dotenvx get "$BUCKET_VAR" --env-file terraform/.env)"
          FOLDER_NAME="${{ inputs.folder_name }}"
          RESTORE_DIR="${VOLUME_NAME}-restore"

          echo "=== Starting Restore of $SERVICE from: $GCS_BUCKET/$FOLDER_NAME ==="
          echo "Service: $SERVICE"
          echo "Volume: $VOLUME_NAME"
          echo "Bucket: $GCS_BUCKET"

          echo "Downloading data from GCS..."
          mkdir -p ./$RESTORE_DIR
          gsutil -m rsync -r "$GCS_BUCKET/$FOLDER_NAME" ./$RESTORE_DIR

          ssh eddies@box.javanese-pound.ts.net "rm -rf /home/eddies/$VOLUME_NAME && mkdir -p /home/eddies/$VOLUME_NAME"

          echo "Uploading to server..."
          rsync -avz -e "ssh" ./$RESTORE_DIR/ eddies@box.javanese-pound.ts.net:/home/eddies/$VOLUME_NAME

          echo "âœ“ Restore completed from: $GCS_BUCKET/$FOLDER_NAME"

      - name: Start Application
        if: always()
        run: |
          SERVICE="fizzy"
          VERSION="${{ steps.version.outputs.sha }}"

          if [ -n "$VERSION" ]; then
            echo "Restarting specific version: $VERSION"
            kamal app start --version="$VERSION" -c $SERVICE/config/deploy.yml
          else
            echo "Restarting default version..."
            kamal app start -c $SERVICE/config/deploy.yml
          fi
